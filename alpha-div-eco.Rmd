---
title: "Alpha diveristy across different ecosystems"
author: "Xin (David) Zhao"
date: "Last edited `r format(Sys.time(), '%d %B %Y')`"
knit: (function(inputFile, encoding) {
      out_dir <- 'docs';
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_file=file.path(dirname(inputFile), out_dir, 'index.html'))})
output:
  html_document:
    # theme: cosmo
    highlight: pygments
    df_print: paged
    toc: TRUE
    toc_float: TRUE
    collapsed: FALSE
    number_sections: TRUE
    fig_width: 7
    fig_height: 6
    fig_caption: TRUE
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
---

<html>

<head>

```{=html}
<style>

h1{
 color: #055C9D;
 font-family: Georgia;
 font-size: 200%
}


h2{
 color: #055C9D;
 font-family: helvetica;
 font-size: 150%
}

h3{
 color: #055C9D;  
 font-family: helvetica;
 font-size: 120%; 
}

p {
 color: #333333;
 font-family: helvetica;
 font-size: 100%;
}

.blackbox {
  padding: 1em;
  background: green;
  color: black;
  border: 2px solid orange;
  border-radius: 10px;
}

.center {
  text-align: center;
}

</style>
```
</head>

</html>

```{r setup, include = FALSE}
# set options for the entire document 
knitr::opts_chunk$set(fig.align = 'center', 
                      fig.height=6, fig.width=8,
                      dev="png",
                      echo=TRUE, #display code in output document 
                      error=FALSE,
                      collapse = FALSE, 
                      message=FALSE) #stop render when error occurs   
```

## Problem

## Solution

## Project outline

## R codes

### Load necessary libraries

```{r library, warning=FALSE, collapse=TRUE}

# load library necessary for this project

library(vegan)
library(phyloseq) # import and process qimme output files 
library(phyloseqCompanion)
library(ggpubr)  
library(picante)  # estimate Faith's PD 
library(tidyverse) 

```

### Import metagenomic 16S sequence data and metadata

Human microbiome project (HMP) 16S rRNA gene diversity: examines the
diversity of 16S RNA genes in the human microbiome for the human
microbiome project (HMP)[@aframew2012]

-   Cohort: Center "Healthy Cohort"
-   Data type: 16S metagenomic sequence - NCBI Bioproject ID: 48489
-   300 human subjects, up to 3 time points, 5 body sites
-   Metadata: Unique subject ID, body site, sex and visit number which
    are accessible via [the HMP metadata
    catalog](https://hmpdacc.org/hmp/catalog/grid.php?dataset=metagenomic)

Download Qiime-processed OTU table (v3-5) and phylogenetic trees (v3-5)
from the [website](https://hmpdacc.org/hmp/HMQCP/#data).

```{r import HMP dataset}

# extract OTU table data from .gz files 

otu_v35_hmp <- read.delim(gzfile("C:/Users/17803/Documents/RStuodio-link-GitHub/alpha-diversity-ecosystems/otu_table_v35.txt.gz"),
                      header = FALSE)  # whether the first line describe the column names 

head(otu_v35_hmp)



# unzip the final OTU table after removing mislabeling and contamination 
otu_v35_final_hmp <- read.delim(gzfile("./otu_table_psn_v35.txt.gz"),
                                header = FALSE)  # whether the first line describe the column names 


head(otu_v35_final_hmp[,ncol(otu_v35_final_hmp)]) 

```


Read in the Qiime-output phylogenetic tree object using `phyloseq` R package. Follow the instruction in the section, `4.5 Import from QIIME Legacy` in the [vignette](https://www.bioconductor.org/packages/release/bioc/vignettes/phyloseq/inst/doc/phyloseq-basics.html#load-phyloseq).



```{r phylogenetic tree, warning=FALSE}

# view the instruction of phyloseq package 
# vignette("phyloseq_analysis")

 
# otu table file 
otu_hmp_phylo <- gzfile("./otu_table_psn_v35.txt.gz") 

# phylogenetic tree file 
ph.tree_hmp_phylo <- gzfile("./rep_set_v35.tre.gz") 


# import both files with phyloseq package 
hmp_phyloseq <- import_qiime(otufilename = otu_hmp_phylo,
                             treefilename = ph.tree_hmp_phylo)

hmp_phyloseq  # phylogenetic object 


```
Now the resulting phyloseq-class object contains an `OTU-table`, `taxomony table` and `phylogenetic tree`.  


Mapping file (16S variable region v35) was accessible from this [website](https://hmpdacc.org/hmp/resources/metagenomics_sequencing_analysis.php).

Convert the imported mapping file to phyloseq class `sample data` using `import_qiime_sample_data()` function of phyloseq package. 


```{r metadata}

sample_data_phylo <- import_qiime_sample_data("./v35_map_uniquebyPSN.txt.bz2")   # import Qiime-output sample data  

```


```{r body site}

table(sample_data_phylo$HMPbodysubsite)   # check the distribution of sub-body sites  

```

Next, merge the sample data and previous phyloseq object into a self-consistent, phyloseq-class object, using `merge_phyloseq`. The resulting phyloseq object contains an OTU table, sample-data, and pylogenetic tree. 


```{r merge phyloseq-class object}

hmp_phylo_data <- merge_phyloseq(sample_data_phylo, hmp_phyloseq)  # merge sample data and previous phyloseq-class object  


```


Calculate alpha diversity by following the [vignettes](https://www.bioconductor.org/packages/release/bioc/vignettes/phyloseq/inst/doc/phyloseq-analysis.html#simple-exploratory-graphics)

```{r filter phyloseq data}

# remove OTU not present in any samples 
hmp_filter <- prune_taxa(taxa_sums(hmp_phylo_data) >0, hmp_phylo_data) 

# alpha diversity metrics of interest 
alpha_metrics <- c("Observed", "Chao1", "ACE", "Shannon", "Simpson", "InvSimpson") 

# plot based on alpha-diversity of stool samples alone 

plot_richness(hmp_filter,  # phyloseq object 
              x = "HMPbodysubsite",  # a variable to map to the x-axis 
              color = "HMPbodysubsite", 
              measures = "Shannon")  + # calculate shannon  
        geom_boxplot(alpha = 0.6)




alpha_plot <- plot_richness(hmp_filter,  # phyloseq object 
                            x = "sex",  # a variable to map to the x-axis 
                            color = "HMPbodysubsite",
                            measures = "Chao1") # calculate chao1 


# plot with ggplot2 
ggplot(data = alpha_plot$data,
       aes(x= HMPbodysubsite, y=value, color = sex), 
       alpha = 0,1) +
        geom_boxplot() +
        coord_flip()

```

### Estimate alpha diversity metrics using estimate_richness function 

The function, `estimate_richness` in the `phyloseq` package returns several commonly used alpha-diversity metrics:

- Observed
- Chao1
- ACE
- Shannon
- Simpson
- InvSimpson

Next, calculate alpha-diversity metrics across different sub-body sites, referring to this [instruction](https://rpubs.com/lconteville/713954)

```{r alpha-div estimate}

# 18 sub-body sites 
table(sample_data(hmp_filter)$HMPbodysubsite)

```


Referring to the below map sourced from the human microbiome project, I assigned sub-body sites to five (major) body sites. 

![Where are body sites](Sub-bodysite-cartoon.jpg)


```{r add-a-new-column}

# add body_site to the sample data 
# convert sample data to data frame for following manipulation 
sample_data2 <- phyloseqCompanion::sample.data.frame(hmp_filter) 

class(sample_data2) # check if data frame 

sample_data2 <- sample_data2 %>% 
  mutate(body_site = case_when(
    HMPbodysubsite %in% c("Attached_Keratinized_gingiva",
                          "Buccal_mucosa",
                          "Hard_palate",
                          "Palatine_Tonsils",
                          "Saliva",
                          "Subgingival_plaque",
                          "Supragingival_plaque",
                          "Throat",
                          "Tongue_dorsum") ~ "oral_cavity",
    HMPbodysubsite %in% c(
      "Anterior_nares"
    )~ "nasal_cavtiy",
    HMPbodysubsite %in% c(
      "Left_Antecubital_fossa",
      "Right_Antecubital_fossa",
      "Left_Retroauricular_crease",
      "Right_Retroauricular_crease"
    )~ "skin",
    HMPbodysubsite %in% c(
      "Stool"
    ) ~ "gastrointestinal_tract",
    HMPbodysubsite %in% c(
      "Mid_vagina",
      "Posterior_fornix",
      "Vaginal_introitus"
    ) ~ "urogenital_tract")
    )

# check the new column 
table(sample_data2$body_site)


# integrate the updated sample data into the phyloseq object 

sample_data3 <- sample_data(sample_data2)

hmp_filter2 <- merge_phyloseq(sample_data3, hmp_phyloseq)  


```


Estimate alpha-diversity measures by body sites 

```{r alpha-diversity-5-body-sites, warning=FALSE}

alpha_div_hmp <- phyloseq::estimate_richness(hmp_filter2, 
                                             split = TRUE, 
                                             measures = c("Observed", # remove Fisher since vegan implementation dose not work anymore  
                                                          "Chao1", 
                                                          "ACE", 
                                                          "Shannon", 
                                                          "Simpson", 
                                                          "InvSimpson"))

head(alpha_div_hmp) # view first rows 

```

Next, compare various alpha-diversity metrics across five body sites - Are alpha diversity different among body sites? 

```{r shannon-anova}

# check if normal distribution for Shannon 

hist(alpha_div_hmp$Shannon, main = "Shannon index", xlab = "") 


```


It seems somewhat right-shewed. Run anova test to evaluate whether body sites are associated with Shannon diversity. 

```{r shannon-anova}

anova.sh <- aov(alpha_div_hmp$Shannon ~ sample_data(hmp_filter2)$body_site)  
summary(anova.sh)

```
Run a post hoc test, Tukey honest significance difference (Tukey's HSD) after the ANOVA test. 

```{r post-hoc-test}

TukeyHSD(anova.sh)

```


Alternatively, run Kruskal-Wallis rank sum test on non-normal distributed dataset. 

```{r kw-test}

kruskal.test(alpha_div_hmp$Shannon ~ sample_data(hmp_filter2)$body_site) 

```
Get p-values of the Wilcoxon tests comparing each pair of groups. 

```{r wilcoxon-test}

pairwise.wilcox.test(alpha_div_hmp$Shannon, sample_data(hmp_filter2)$body_site, 
                     p.adj = "bonf")  # multiple comparison adjustment - bonferroni 


```


### Estimate Faith's PD using picante R package 

The package `picante` can estimate the phylogenetic aware metric, Faith's PD, which `phyloseq` package cannot do. 

Apply `pd` function to OTU table and phylogenetic tree, following the [instruction](https://rdrr.io/rforge/picante/man/pd.html). The function `pd` returns a data frame of the PD and species (SR) values for all samples. 

```{r faith's PD, warning=FALSE}

faith_pd <- picante::pd(samp = t(otu_table(hmp_filter2)), 
            tree = phy_tree(hmp_filter2), 
            include.root = T)  

 
```



